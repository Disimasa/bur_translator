# Оптимизация памяти для сервиса трансляции

## Внесенные изменения для решения проблемы утечки памяти:

### 1. Оптимизация модели PyTorch (`translator.py`)
- **CPU-only режим**: Автоматическое использование CPU (нет CUDA)
- **Float32**: Сохранение качества модели с `torch_dtype=torch.float32`
- **Агрессивная очистка памяти**: `gc.collect()` до и после каждого запроса
- **Обработка ошибок**: Очистка памяти даже при возникновении исключений

### 2. Улучшение API (`api.py`)
- **Ограничение длины текста**: Максимум 2000 символов на запрос
- **Принудительная очистка**: Очистка памяти после каждого запроса
- **Минимальное логирование**: Только ошибки для уменьшения нагрузки
- **Умный health check**: Автоматический перезапуск при превышении 85% памяти
- **Проактивная очистка**: Очистка памяти при превышении 80% использования

### 3. Оптимизация Docker конфигурации
- **4 воркера**: Сохранение параллельной обработки запросов
- **Увеличенные таймауты**: 1200 секунд для загрузки модели
- **Ограничения памяти**: 6GB лимит, 2GB резервация
- **Переменные окружения**: Настройки OpenMP и MKL для CPU

### 4. Автоматический перезапуск при утечке памяти
- **Умный health check**: Проверка использования памяти каждые 30 секунд
- **Автоматический перезапуск**: При превышении 85% памяти контейнер перезапускается
- **Проактивная очистка**: При 80% памяти выполняется принудительная очистка
- **Мониторинг**: `memory_monitor.py` для отслеживания использования памяти

## Команды для мониторинга:

### Проверка состояния сервиса:
```bash
curl http://localhost:3020/health
```

### Мониторинг памяти контейнера:
```bash
docker stats
```

### Запуск скрипта мониторинга:
```bash
python backend/memory_monitor.py
```

### Перезапуск сервиса:
```bash
docker-compose up -d --build
```

## Ожидаемые результаты:
- Стабильное использование памяти без роста
- Агрессивная очистка памяти до и после каждого запроса
- Сохранение качества модели с float32
- Параллельная обработка запросов с 4 воркерами
- **Автоматический перезапуск** при критическом использовании памяти (>85%)
- Проактивная очистка памяти при высоком использовании (>80%)

## Как работает автоматический перезапуск:

### Health Check логика:
1. **Каждые 30 секунд** Docker проверяет `/health` эндпоинт
2. **При 80% памяти**: Выполняется принудительная очистка памяти
3. **При 85% памяти**: Health check возвращает HTTP 503 (Service Unavailable)
4. **Docker автоматически перезапускает** контейнер при получении 503 статуса
5. **Контейнер перезапускается** с чистой памятью и загруженной моделью

### Преимущества:
- **Автоматическое восстановление** без ручного вмешательства
- **Предотвращение полного исчерпания памяти**
- **Минимальное время простоя** (только время перезапуска)
- **Сохранение качества сервиса** при утечках памяти

## Дополнительные рекомендации:
1. Регулярно мониторьте использование памяти через `/health` эндпоинт
2. При необходимости можно уменьшить `max_input_length` в `translator.py`
3. Используйте скрипт `memory_monitor.py` для отслеживания утечек памяти
4. Настройте алерты на превышение лимитов памяти
5. При проблемах с памятью рассмотрите уменьшение `num_beams` в методе `translate`
6. **Пороги памяти можно настроить** в коде health check (80% и 85%)
